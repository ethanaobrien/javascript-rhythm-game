<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>wosu - osu on the web</title>
    <style>
    	* { padding: 0; margin: 0; }
    	canvas { background: #eee; display: block; margin: 0 auto; }
    </style>
</head>
<body>

<canvas id="myCanvas" width="1000" height="600"></canvas>
<script>
    window.onerror = function(e) {
        alert(e)
        alert(e.message)
        
    }
</script>
<script src="resources.js"></script>
<script src='jszip.js'></script>
<script src='beatmapParser.js'></script>
<script>
    
    /*
    TODOs
    Center arrow buttons
    Sound on click
    Add sliders
    Better Spinner UI
    Seperate functions into files
    
    */
    
    function game(canvas) {
        this.canvas = canvas
        this.ctx = this.canvas.getContext("2d")
        
        this.resizeCanvas()
        
        this.x = this.canvas.width / 2
        this.y = this.canvas.height / 2
        
        this.rightPressed = false
        this.leftPressed = false
        this.downPressed = false
        this.upPressed = false
        this.paused = false
        this.zxcPressed = false
        
        this.stats = []
        this.minusScore = 150
        this.addScore = 300
        this.playing = false
        
        this.arrowMoving = []
        this.testingArrows = []
        //this.arrowMoving.push({direction: "left"})
        
        this.arrowCords = {"left": {"x": 500, "y": 325},
                           "up": {"x": 200, "y": -625},
                           "right": {"x": -775, "y": -315}, // TODO - Center arrow buttons
                           "down": {"x": -455, "y": 640},
                           "travelDistance": 200 // Add option to change this in settings?
                          }
        this.safeZone = 150 // Should I add the ability to change this in settings?
        this.moveSpeed = 4
        this.currentCircles = []
        this.pendingButtons = []
        this.toClick = []
        this.sliders = []
        
        this.zip = new JSZip()
        
        this.stage = 'title screen'
        this.draw()
        
        this.radius = 10
        
        this.audio = {"src": null, "data": null, "element": document.createElement('audio'), "selected": false, "loaded": false}
        this.background = {"src": null, "data": null, "element": document.createElement('img'), "selected": false, "loaded": false}
        this.videoBack = {"src": null, "data": null, "element": document.createElement('video'), "selected": false, "loaded": false}
        this.recording = false
        this.data = {
            "recording": {
                "keys": []
            }
        }
        this.extension = 'fgh' // The extension of the save/load file. Should I have a different name?
        this.fileName = null
        this.origData = null
        this.zipStatus = null
        this.zipping = false
        this.unzipping = false
        this.delayTime = 0.540
        this.moveArrowsInter = null
        this.checkZone = 50
        this.checkButtonsInter = null
        this.beatmap = null
        this.mouseX = 0
        this.mouseY = 0
        this.fadeImageVideo = 0.5 // TODO - Add to settings
        this.mouseColor = 'red' // TODO - Add to settings
        
        this.mouseMoveBind = this.moveMouse.bind(this)
        function lockChangeAlert() {
            if (document.pointerLockElement === this.canvas ||
                document.mozPointerLockElement === this.canvas) {
                document.addEventListener("mousemove", this.mouseMoveBind, false);
            } else {
                document.removeEventListener("mousemove", this.mouseMoveBind, false);
            }
        }
        document.addEventListener('pointerlockchange', lockChangeAlert.bind(this), false);
        document.addEventListener('mozpointerlockchange', lockChangeAlert.bind(this), false);
        
        this.canvas.requestPointerLock = this.canvas.requestPointerLock ||
                                         this.canvas.mozRequestPointerLock
        
        this.score = 0
        this.dispScore = 0
        this.draw()
        this.canvas.addEventListener('click', this.click.bind(this), false)
        document.addEventListener("keydown", this.down.bind(this), false)
        document.addEventListener("keyup", this.up.bind(this), false)
        document.addEventListener("visibilitychange", this.hidden.bind(this), false)
        window.addEventListener('resize', this.resizeCanvas.bind(this), false)
        if (window.requestAnimationFrame) {
            requestAnimationFrame(this.draw.bind(this))
        } else {
            setInterval(this.draw.bind(this), 10)
        }
        if (typeof JSON.clone != "function") {
            JSON.clone = function(obj) {
                return JSON.parse(JSON.stringify(obj));
            };
        }
    }
    game.prototype = {
        moveMouse: function(e) {
            this.mouseX += e.movementX
            this.mouseY += e.movementY
            if (this.mouseX > this.canvas.width) {
                this.mouseX = this.canvas.width
            }
            if (this.mouseY > this.canvas.height) {
                this.mouseY = this.canvas.height
            }
            if (this.mouseX < 0) {
                this.mouseX = 0
            }
            if (this.mouseY < 0) {
                this.mouseY = 0
            }
            if (document.pointerLockElement !== this.canvas || document.mozPointerLockElement === this.canvas) { 
                document.removeEventListener("mousemove", this.mouseMoveBind, false);
            }
        },
        drawMouse: function() {
            var ctx = this.ctx
            ctx.beginPath()
            ctx.arc(this.mouseX, this.mouseY, 13, 0, Math.PI*2, false)
            ctx.fillStyle = this.mouseColor
            ctx.fill()
            ctx.closePath()
        },
        isTouching: function(a, b, c, d, circle) {
            if (circle) {
                a = a-c
                b = b-c
                c = c*2
                d = c*2
            }
            var e = window.event;
            var x = this.mouseX
            var y = this.mouseY
            var cords = [a, b, c, d]
            if (x<cords[2] + cords[0] && x>cords[0] && y>cords[1] && y<cords[3] + cords[1]) {
                return true
            } else {
                return false
            }
        },
        click: function() {
            if (document.pointerLockElement === null) {
                this.canvas.requestPointerLock()
                var e = window.event;
                this.mouseX = e.pageX
                this.mouseY = e.pageY
            }
            if (this.stage == 'title screen') {
                var x = this.canvas.width / 2
                var y = this.canvas.height / 2
                if (this.isTouching(x, y, y-50, null, true)) {
                    this.stage = 'title2 screen'
                } else if (this.isTouching(this.canvas.width - 60, this.canvas.height - 60, window.gitHubLogo.naturalWidth/10, window.gitHubLogo.naturalHeight/10)) {
                    window.open('https://github.com/ethanaobrien/wosu')
                }
            } else if (this.stage == 'create screen') {
                if (this.isTouching(20, 20, 150, 50)) {
                    if (this.recording) {
                        this.stopRecording()
                    } else {
                        this.record()
                    }
                } else if (this.isTouching(175, 20, 150, 50)) {
                    this.save()
                } else if (this.isTouching((this.canvas.width/4 * 3) + 125, 20, 200, 50)) {
                    this.reset()
                } else if (this.isTouching((this.canvas.width/4 * 3) + 125, 90, 200, 50)) {
                    this.stage = 'settings'
                } else if (this.isTouching(20, 80, 150, 50)) {
                    this.reset()
                    this.stage = 'create screen'
                }
            } else if (this.stage == 'title2 screen') {
                
                
                
                if (this.isTouching((this.canvas.width / 2) - 225, 70, 180, 50)) {
                    this.ask4File()
                } else if (this.isTouching((this.canvas.width / 2), 70, 180, 50)) {
                    this.stage = 'create screen'
                } else if (this.isTouching((this.canvas.width/4 * 3) + 125, 20, 200, 50)) {
                    this.stage = 'title screen'
                } else if (this.isTouching((this.canvas.width / 2) - 110, 210, 180, 50)) {
                    this.selectOsuFile()
                }
                
                
                
            } else if (this.stage == 'play screen') {
                if (this.isTouching((this.canvas.width/4 * 3) + 125, 20, 200, 50)) {
                    this.reset()
                } else if (this.isTouching((this.canvas.width/4 * 3) + 125, 85, 200, 50)) {
                    this.score = 0
                    this.dispScore = 0
                    this.restartAV()
                    this.pause()
                    this.arrowMoving = []
                    this.stats = []
                    this.data.recording = JSON.clone(this.origData)
                    setTimeout(() => {
                        this.play()
                    }, 200)
                } else if (this.isTouching((this.canvas.width/4 * 3) + 125, 150, 200, 50)) {
                    if (this.paused) {
                        this.paused = false
                        this.play()
                    } else {
                        this.paused = true
                        this.pause()
                    }
                }
            } else if (this.stage == 'results screen') {
                if (this.isTouching((this.canvas.width/4 * 3) + 125, 20, 200, 50)) {
                    this.reset()
                } else if (this.isTouching(20, 20, 150, 50)) {
                    this.stage = 'play screen'
                    this.score = 0
                    this.dispScore = 0
                    this.restartAV()
                    this.pause()
                    this.arrowMoving = []
                    this.stats = []
                    this.data.recording = JSON.clone(this.origData)
                    setTimeout(() => {
                        this.play()
                    }, 200)
                }
            } else if (this.stage == 'settings') {
                if (this.isTouching((this.canvas.width/4 * 3) + 125, 20, 200, 50)) {
                    this.stage = 'create screen'
                } else if (this.isTouching((this.canvas.width/2) - 200, 20, 300, 50)) {
                    this.uploadBackgroundImage()
                } else if (this.isTouching((this.canvas.width/2) - 200, 100, 300, 50)) {
                    this.uploadBackgroundVideo()
                } else if (this.isTouching((this.canvas.width/2) - 200, 180, 300, 50)) {
                    this.chooseAudio()
                }
            } else if (this.stage == 'title2 settings') {
                if (this.isTouching((this.canvas.width/4 * 3) + 125, 20, 200, 50)) {
                    this.stage = 'title2 screen'
                } else if (this.isTouching((this.canvas.width/2) - 200, 120, 50, 50)) {
                    if (this.moveSpeed > 1) {
                        this.moveSpeed--
                    }
                } else if (this.isTouching((this.canvas.width/2) + 150, 120, 50, 50)) {
                    if (this.moveSpeed < 10) {
                        this.moveSpeed++
                    }
                }
            } else if (this.stage == 'osu play') {
                this.screenPress()
                if (this.isTouching((this.canvas.width/4 * 3) + 125, 20, 200, 50)) {
                    this.reset()
                } else if (this.isTouching((this.canvas.width/4 * 3) + 125, 85, 200, 50)) {
                    this.score = 0
                    this.dispScore = 0
                    this.restartAV()
                    this.pause()
                    this.stats = []
                    this.currentCircles = []
                    this.pendingButtons = []
                    this.beatmap = JSON.clone(this.origData)
                    setTimeout(() => {
                        this.play()
                    }, 200)
                } else if (this.isTouching((this.canvas.width/4 * 3) + 125, 150, 200, 50)) {
                    if (this.paused) {
                        this.paused = false
                        this.play()
                    } else {
                        this.paused = true
                        this.pause()
                    }
                }
            } else if (this.stage == 'select osu difficulty') {
                for (var i=0; i<this.toClick.length; i++) {
                    var a = this.toClick[i][0]
                    var b = this.toClick[i][1]
                    var c = this.toClick[i][2]
                    var d = this.toClick[i][3]
                    if (this.isTouching(a, b, c, d)) {
                        this.gotDifficulty(this.toClick[i][4])
                        return
                    }
                }
            } else if (this.stage == 'osu results screen') {
                if (this.isTouching((this.canvas.width/4 * 3) + 125, 20, 200, 50)) {
                    this.reset()
                } else if (this.isTouching(20, 20, 150, 50)) {
                    this.stage = 'osu play'
                    this.score = 0
                    this.dispScore = 0
                    this.restartAV()
                    this.pause()
                    this.stats = []
                    this.currentCircles = []
                    this.pendingButtons = []
                    this.beatmap = JSON.clone(this.origData)
                    setTimeout(() => {
                        this.play()
                    }, 200)
                }
            }
        },
        titleScreen: function() {
            var x = this.canvas.width / 2
            var y = this.canvas.height / 2
            this.ctx.beginPath()
            this.ctx.arc(x, y, y - 50, 0, Math.PI*2, false)
            this.ctx.fillStyle = "pink";
            this.ctx.globalAlpha = .75
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.closePath()
            this.ctx.globalAlpha = 1
            this.ctx.font = "60px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Play", x - 60, y);
            
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Version 1.0.1", 20, this.canvas.height-20);
            
            this.ctx.drawImage(window.gitHubLogo, this.canvas.width - 60, this.canvas.height - 60, window.gitHubLogo.naturalWidth/10, window.gitHubLogo.naturalHeight/10);
            
            
        },
        title2Screen: function() {
            
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Arrow Mode", (this.canvas.width/2) - 100, 40);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width / 2) - 225, 70, 180, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Choose File", (this.canvas.width / 2) - 190, 100);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width / 2), 70, 180, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Create Mapping", (this.canvas.width / 2) + 20, 100);
            
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("wosu mode", (this.canvas.width/2) - 100, 180);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width / 2) - 110, 210, 180, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Choose Beatmap", (this.canvas.width / 2) - 100, 240);
            
            /*
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width / 2) - 125, 20, 230, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Click to upload ." + this.extension + " file", (this.canvas.width / 2) - 110, 50);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width / 2) - 150, 120, 300, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Upload osu beatmap (beta)", (this.canvas.width / 2) - 125, 150);
            */
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 20, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("To Home", (this.canvas.width/4 * 3) + 175, 50);
        },
        title2Settings: function() {
            
            
            
            this.ctx.font = "40px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Speed", (this.canvas.width/2) - 75, 70);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/2) - 200, 120, 50, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("-", (this.canvas.width/2) - 180, 150);
            
            this.ctx.font = "40px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText(this.moveSpeed, (this.canvas.width/2) - 10, 150);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/2) + 150, 120, 50, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("+", (this.canvas.width/2) + 170, 150);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 20, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Back", (this.canvas.width/4 * 3) + 170, 50);
        },
        arrow: function(a, b, filled) {
            var ctx = this.ctx
            ctx.beginPath()
            ctx.moveTo(a, b)
            ctx.lineTo(a-50, b)
            ctx.lineTo(a-50, b+20)
            ctx.lineTo(a-85, b-8)
            ctx.lineTo(a-50, b-35)
            ctx.lineTo(a-50, b-15)
            ctx.lineTo(a, b-15)
            ctx.moveTo(a, b)
            if (filled == 'green') {
                ctx.fillStyle = 'yellow'
            } else if (filled) {
                ctx.fillStyle = "red"
            } else {
                ctx.fillStyle = "black"
            }
            ctx.stroke()
            ctx.fill()
        },
        checkArrowDeletion: function(e) {
            var left = false, right = false, up = false, down = false, remove = false
            var key = e.key
            if (e.repeat) {
                return
            }
            if (key == 'ArrowUp') {
                up = true
            } else if (key == 'ArrowDown') {
                down = true
            } else if (key == 'ArrowRight') {
                right = true
            } else if (key == 'ArrowLeft') {
                left = true
            }
            var newArrows = []
            for (var i=0; i<this.arrowMoving.length; i++) {
                var remove = false
                if (this.arrowMoving[i].direction == 'left') {
                    if (left && this.arrowCords.left.x-this.checkZone<this.arrowMoving[i].x && this.arrowMoving[i].x<this.arrowCords.left.x+this.safeZone && ! this.paused) {
                        var left = false
                        var remove = true
                        var minusPoints = Math.abs(this.arrowMoving[i].x - this.arrowCords.left.x)
                        this.changeScore(this.addScore - minusPoints)
                        this.stats.push({score: this.addScore - minusPoints})
                    } else {
                        newArrows.push(this.arrowMoving[i])
                    }
                } else if (this.arrowMoving[i].direction == 'up') {
                    if (up && this.arrowCords.up.x-this.checkZone<this.arrowMoving[i].y && this.arrowMoving[i].y<this.arrowCords.up.x+this.safeZone && ! this.paused) {
                        var up = false
                        var remove = true
                        var minusPoints = Math.abs(this.arrowMoving[i].y - this.arrowCords.up.x)
                        this.changeScore(this.addScore - minusPoints)
                        this.stats.push({score: this.addScore - minusPoints})
                    } else {
                        newArrows.push(this.arrowMoving[i])
                    }
                } else if (this.arrowMoving[i].direction == 'right') {
                    if (right && this.arrowCords.right.x-this.checkZone<this.arrowMoving[i].x && this.arrowMoving[i].x<this.arrowCords.right.x+this.safeZone && ! this.paused) {
                        var right = false
                        var remove = true
                        var minusPoints = Math.abs(this.arrowMoving[i].x - this.arrowCords.right.x)
                        this.changeScore(this.addScore - minusPoints)
                        this.stats.push({score: this.addScore - minusPoints})
                    } else {
                        newArrows.push(this.arrowMoving[i])
                    }
                } else if (this.arrowMoving[i].direction == 'down') {
                    if (down && this.arrowCords.down.x-this.checkZone<this.arrowMoving[i].y && this.arrowMoving[i].y<this.arrowCords.down.x+this.safeZone && ! this.paused) {
                        var down = false
                        var remove = true
                        var minusPoints = Math.abs(this.arrowMoving[i].y - this.arrowCords.down.x)
                        this.changeScore(this.addScore - minusPoints)
                        this.stats.push({score: this.addScore - minusPoints})
                    } else {
                        newArrows.push(this.arrowMoving[i])
                    }
                }
            }
            this.arrowMoving = newArrows
        },
        drawMovingArrows: function() {
            var newArrows = []
            for (var i=0; i<this.arrowMoving.length; i++) {
                if (this.arrowMoving[i].direction == 'left') {
                    if (! this.arrowMoving[i].x) {
                        this.arrowMoving[i].x = this.arrowCords.left.x - this.arrowCords.travelDistance
                    }
                    this.arrow(this.arrowMoving[i].x, this.arrowCords.left.y, 'green')
                    if (this.arrowMoving[i].x < this.arrowCords.left.x + 50) {
                        newArrows.push(this.arrowMoving[i])
                    } else if (this.arrowMoving[i].x > this.arrowCords.left.x + 50) {
                        this.stats.push({score: -this.minusScore})
                        this.changeScore(-this.minusScore)
                    }
                } else if (this.arrowMoving[i].direction == 'up') {
                    if (! this.arrowMoving[i].y) {
                        this.arrowMoving[i].y = this.arrowCords.up.x - this.arrowCords.travelDistance
                    }
                    this.ctx.rotate(90 * Math.PI / 180)
                    this.arrow(this.arrowMoving[i].y, this.arrowCords.up.y, 'green')
                    this.ctx.rotate(-(90 * Math.PI / 180))
                    if (this.arrowMoving[i].y < this.arrowCords.up.x + 50) {
                        newArrows.push(this.arrowMoving[i])
                    } else if (this.arrowMoving[i].y > this.arrowCords.up.x + 50) {
                        this.stats.push({score: -this.minusScore})
                        this.changeScore(-this.minusScore)
                    }
                } else if (this.arrowMoving[i].direction == 'right') {
                    if (! this.arrowMoving[i].x) {
                        this.arrowMoving[i].x = this.arrowCords.right.x - this.arrowCords.travelDistance
                    }
                    this.ctx.rotate(180 * Math.PI / 180)
                    this.arrow(this.arrowMoving[i].x, this.arrowCords.right.y, 'green')
                    this.ctx.rotate(-(180 * Math.PI / 180))
                    if (this.arrowMoving[i].x < this.arrowCords.right.x + 50) {
                        newArrows.push(this.arrowMoving[i])
                    } else if (this.arrowMoving[i].x > this.arrowCords.right.x + 50) {
                        this.stats.push({score: -this.minusScore})
                        this.changeScore(-this.minusScore)
                    }
                } else if (this.arrowMoving[i].direction == 'down') {
                    if (! this.arrowMoving[i].y) {
                        this.arrowMoving[i].y = this.arrowCords.down.x - this.arrowCords.travelDistance
                    }
                    this.ctx.rotate(90 * 3 * Math.PI / 180)
                    this.arrow(this.arrowMoving[i].y, this.arrowCords.down.y, 'green')
                    this.ctx.rotate(90 * Math.PI / 180)
                    if (this.arrowMoving[i].y < this.arrowCords.down.x + 50) {
                        newArrows.push(this.arrowMoving[i])
                    } else if (this.arrowMoving[i].y > this.arrowCords.down.x + 50) {
                        this.stats.push({score: -this.minusScore})
                        this.changeScore(-this.minusScore)
                    }
                }
            }
            this.arrowMoving = newArrows
        },
        moveArrows: function() {
            for (var i=0; i<this.arrowMoving.length; i++) {
                var remove = false
                if (this.arrowMoving[i].direction == 'left') {
                    if (! this.arrowMoving[i].x) {
                        this.arrowMoving[i].x = this.arrowCords.left.x - this.arrowCords.travelDistance
                    }
                    if (! this.paused) {
                        this.arrowMoving[i].x += this.moveSpeed
                    }
                } else if (this.arrowMoving[i].direction == 'up') {
                    if (! this.arrowMoving[i].y) {
                        this.arrowMoving[i].y = this.arrowCords.up.x - this.arrowCords.travelDistance
                    }
                    if (! this.paused) {
                        this.arrowMoving[i].y += this.moveSpeed
                    }
                } else if (this.arrowMoving[i].direction == 'right') {
                    if (! this.arrowMoving[i].x) {
                        this.arrowMoving[i].x = this.arrowCords.right.x - this.arrowCords.travelDistance
                    }
                    if (! this.paused) {
                        this.arrowMoving[i].x += this.moveSpeed
                    }
                } else if (this.arrowMoving[i].direction == 'down') {
                    if (! this.arrowMoving[i].y) {
                        this.arrowMoving[i].y = this.arrowCords.down.x - this.arrowCords.travelDistance
                    }
                    if (! this.paused) {
                        this.arrowMoving[i].y += this.moveSpeed
                    }
                }
            }
        },
        ask4File: function() {
            var file = document.createElement('input')
            file.type = 'file'
            file.accept = "." + this.extension
            file.onchange = async function(e) {
                this.unzipping = true
                this.stage = 'play screen'
                this.paused = false
                var contents = await this.zip.loadAsync(e.target.files[0])
                var data = await contents.file("data.json").async("string")
                var data = JSON.parse(data)
                this.data.recording = data
                this.origData = JSON.clone(data)
                if (contents.files['audio']) {
                    var audio = await contents.file("audio").async("arrayBuffer")
                    this.audio.data = audio
                    this.audio.src = URL.createObjectURL(new Blob([this.audio.data]))
                    this.audio.selected = true
                    this.audio.element.src = this.audio.src
                }
                if (contents.files['background']) {
                    var background = await contents.file("background").async("arrayBuffer")
                    this.background.data = background
                    this.background.src = URL.createObjectURL(new Blob([this.background.data]))
                    this.background.selected = true
                    this.background.element.src = this.background.src
                }
                if (contents.files['video']) {
                    var video = await contents.file("video").async("arrayBuffer")
                    this.videoBack.data = video
                    this.videoBack.src = URL.createObjectURL(new Blob([this.videoBack.data]))
                    this.videoBack.selected = true
                    this.videoBack.element.src = this.videoBack.src
                }
                this.unzipping = false
                setTimeout(function() {
                    this.play()
                    this.addListener('ended', function() {this.stage = 'results screen'}.bind(this), false)
                    //window.a = function() {this.videoBack.element.currentTime = this.videoBack.element.duration - 5}.bind(this)
                }.bind(this), 100) // Should I add a countdown on the screen?
            }.bind(this)
            file.click()
        },
        osuDifficulty: function() {
            if (this.beatmap === null) {
                this.ctx.font = "30px Arial";
                this.ctx.fillStyle = "black";
                this.ctx.fillText('Loading...', (this.canvas.width / 2) - 100, 100);
                return
            }
            var toClick = []
            var a = 20
            var b = 50
            var c = (this.canvas.width/2) - 200
            var d = (this.canvas.width/2) - 170
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Select game Mode", (this.canvas.width/2) - 170, b);
            a += 80
            b += 80
            for (var i=0; i<this.beatmap.modes.length; i++) {
                this.ctx.beginPath()
                this.ctx.rect(c, a, 300, 50)
                toClick.push([c, a, 300, 50, this.beatmap.modes[i]])
                this.ctx.fillStyle = "yellow"
                this.ctx.stroke()
                this.ctx.fill()
                this.ctx.font = "20px Arial";
                this.ctx.fillStyle = "black";
                this.ctx.fillText(this.beatmap.modes[i], d, b);
                a += 80
                b += 80
                if (a + 80 > this.canvas.height) {
                    var a = 100
                    var b = 130
                    c += 350
                    d += 350
                }
            }
            this.toClick = toClick
        },
        selectOsuFile: function() {
            var file = document.createElement('input')
            file.type = 'file'
            file.accept = ".osz,.zip"
            file.onchange = async function(e) {
                this.beatmap = await beatmapParser(e.target.files[0])
                if (this.beatmap.modes.length == 1) {
                    this.gotDifficulty(this.beatmap.modes[0])
                } else {
                    this.stage = 'select osu difficulty'
                }
            }.bind(this)
            file.click()
        },
        gotDifficulty: async function(a) {
            this.stage = 'osu play'
            this.unzipping = true
            this.paused = false
            var beatmap = await this.beatmap.c(a)
            this.beatmap = {buttons: beatmap['[HitObjects]'], timing: beatmap['[TimingPoints]'], difficulty: beatmap['[Difficulty]']}
            this.audio.src = beatmap['[General]'].Audio
            this.audio.selected = true
            this.audio.element.src = this.audio.src
            if (beatmap['[Events]'].image) {
                this.background.src = beatmap['[Events]'].image
                this.background.element.onload = function() {this.background.loaded = true}.bind(this)
                this.background.selected = true
                this.background.element.src = this.background.src
            }
            if (beatmap['[Events]'].video) {
                this.videoBack.src = beatmap['[Events]'].video
                this.videoBack.selected = true
                this.videoBack.element.onloadeddata = function() {this.videoBack.loaded = true}.bind(this)
                this.videoBack.element.src = this.videoBack.src
                this.videoBack.element.load()
                this.videoBack.muted = true
            }
            if (beatmap['[TimingPoints]']) {
                this.beatmap.timingPoints = beatmap['[TimingPoints]']
            }
            this.origData = JSON.clone(this.beatmap)
            if (! beatmap['[General]'].AudioLeadIn || (beatmap['[General]'].AudioLeadIn && beatmap['[General]'].AudioLeadIn >= 0)) {
                setTimeout(function() {
                    this.play()
                    this.addListener('ended', function() {this.stage = 'osu results screen'}.bind(this), false)
                }.bind(this), 100)
            } else {
                var q = beatmap['[General]'].AudioLeadIn
                this.currentTime = -q / 1000
                var a = setInterval(function() {
                    this.currentTime += 0.02
                }.bind(this), 20)
                setTimeout(function() {
                    clearInterval(a)
                    delete this.currentTime
                    this.play()
                    this.addListener('ended', function() {this.stage = 'osu results screen'}.bind(this), false)
                }.bind(this), q)
                this.playing = true
            }
            this.unzipping = false
        },
        adaptCirclePlacement: function(x, y) {
            var w = 640 // (somewhat) adjust osu resolution (normal is 640x480)
            var h = 480
            var aspectRatio = w / h
            if (this.canvas.width > this.canvas.height) {
                while (h < this.canvas.height) {
                    w = w * 1.01
                    h = h * 1.01
                }
                while (h > this.canvas.height) {
                    w = w / 1.01
                    h = h / 1.01
                }
            } else {
                while (w > this.canvas.width) {
                    w = w / 1.01
                    h = h / 1.01
                }
                while (w < this.canvas.width) {
                    w = w * 1.01
                    h = h * 1.01
                }
            }
            // center-ish
            if (this.canvas.width > this.canvas.height) {
                if (this.canvas.width - 640 != 0) {
                    x = x * this.canvas.width / 640
                    y = y * this.canvas.height / 480
                }
            } else {
                if (this.canvas.height - 480 != 0) {
                    y = (this.canvas.height - 480) / 2
                }
            }
            x += 10
            y += 10
            return {x: x, y: y}
        },
        drawCircle: function(x, y, c) {
            var {x, y} = this.adaptCirclePlacement(x, y)
            var ctx = this.ctx
            ctx.beginPath()
            ctx.arc(x, y, 40, 0, Math.PI*2, false)
            ctx.fillStyle = c || "green"
            ctx.fill()
            ctx.closePath()
        },
        drawLineAroundCircle: function(x, y, displacement) {
            var radius = 40
            var maxRadius = 60
            var o = 60
            var {x, y} = this.adaptCirclePlacement(x, y)
            var ctx = this.ctx
            ctx.beginPath()
            ctx.arc(x, y, o, 0, Math.PI*2, false)
            ctx.stroke()
            ctx.closePath()
        },
        drawCircles: function() {
            var newButtons = []
            for (var i=0; i<this.pendingButtons.length; i++) {
                if (this.getCurrentTime()*1000 > this.pendingButtons[i].time) {
                    this.currentCircles.push(this.pendingButtons[i])
                } else {
                    newButtons.push(this.pendingButtons[i])
                }
            }
            this.pendingButtons = newButtons
            for (var i=0; i<this.pendingButtons.length; i++) {
                this.drawCircle(this.pendingButtons[i].x, this.pendingButtons[i].y)
                var displacement = this.pendingButtons[i].time - this.getCurrentTime()*1000
                var radius = 40
                var o = radius + (displacement / 5)
                var {x, y} = this.adaptCirclePlacement(this.pendingButtons[i].x, this.pendingButtons[i].y)
                var ctx = this.ctx
                ctx.lineWidth = 3
                ctx.beginPath()
                ctx.arc(x, y, o, 0, Math.PI*2, false)
                ctx.stroke()
                ctx.closePath()
                ctx.lineWidth = 1
            }
            for (var i=0; i<this.currentCircles.length; i++) {
                this.drawCircle(this.currentCircles[i].x, this.currentCircles[i].y)
            }
        },
        checkButtons: function() {
            var newButtons = []
            for (var i=0; i<this.currentCircles.length; i++) {
                if (this.getCurrentTime()*1000 > this.currentCircles[i].time+250) {
                    this.stats.push({score: -this.minusScore})
                    this.changeScore(-this.minusScore)
                } else {
                    newButtons.push(this.currentCircles[i])
                }
            }
            this.currentCircles = newButtons
        },
        screenPress: function() {
            if (this.paused) {
                return
            }
            var newButtons = []
            var gottenOne = false
            for (var i=0; i<this.currentCircles.length; i++) {
                var x = this.currentCircles[i].x
                var y = this.currentCircles[i].y
                var {x, y} = this.adaptCirclePlacement(x, y)
                var radius = 40
                if (this.isTouching(x-radius, y-radius, radius*2, radius*2) && ! gottenOne) {
                    gottenOne = true
                    var displacement = this.currentCircles[i].time - this.getCurrentTime()*1000
                    var o = radius + (displacement / 5)
                    var minusPoints = Math.abs(o - radius)
                    this.changeScore(this.addScore - minusPoints)
                    this.stats.push({score: this.addScore - minusPoints})
                } else {
                    newButtons.push(this.currentCircles[i])
                }
            }
            this.currentCircles = newButtons
            
            var newButtons = []
            var gottenOne = false
            for (var i=0; i<this.pendingButtons.length; i++) {
                var x = this.pendingButtons[i].x
                var y = this.pendingButtons[i].y
                var {x, y} = this.adaptCirclePlacement(x, y)
                var radius = 40
                if (this.isTouching(x-radius, y-radius, radius*2, radius*2) && ! gottenOne) {
                    gottenOne = true
                    var displacement = this.pendingButtons[i].time - this.getCurrentTime()*1000
                    var o = radius + (displacement / 5)
                    var minusPoints = Math.abs(o - radius)
                    this.changeScore(this.addScore - minusPoints)
                    this.stats.push({score: this.addScore - minusPoints})
                } else {
                    newButtons.push(this.pendingButtons[i])
                }
            }
            this.pendingButtons = newButtons
        },
        osuResultsScreen: function() {
            if (this.background.selected) {
                this.drawImage()
            }
            if (this.moveArrowsInter) {
                clearInterval(this.moveArrowsInter)
                this.moveArrowsInter = null
            }
            this.ctx.beginPath()
            this.ctx.rect(20, 20, 150, 50)
            this.ctx.fillStyle = "black"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Retry", 75, 50);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 20, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("To Home", (this.canvas.width/4 * 3) + 175, 50);
            
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Score: " + Math.round(this.score), 30, 125);
            
            var results = []
            for (var i=0; i<this.stats.length; i++) {
                if (this.stats[i].score == -this.minusScore) {
                    if (! results.missed) {
                        results.missed = 0
                    }
                    results.missed++
                } else {
                    var a = this.getGood(this.stats[i].score)
                    if (! results[a]) {
                        results[a] = 0
                    }
                    results[a]++
                }
            }
            this.ctx.font = "70px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Results", (this.canvas.width/2) - 125, 100);
            
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            var newResults = []
            for (var k in results) {
                newResults.push({"name": k, "amount": results[k]})
            }
            results = newResults
            results.sort(function(a, b) {
                if (a.name == b.name) {
                    return 0
                } else if (a.name == 'Impossibly Good') {
                    return -1
                } else if (b.name == 'Impossibly Good') {
                    return 1
                } else if (a.name == 'Great') {
                    return -1
                } else if (b.name == 'Great') {
                    return 1
                } else if (a.name == 'Good') {
                    return -1
                } else if (b.name == 'Good') {
                    return 1
                } else if (a.name == 'Bad') {
                    return -1
                } else if (b.name == 'Bad') {
                    return 1
                } else if (a.name == 'Terrible') {
                    return -1
                } else if (b.name == 'Terrible') {
                    return 1
                } else if (a.name == 'Missed') {
                    return -1
                } else if (b.name == 'Missed') {
                    return 1
                } else {
                    return 0
                }
            })
            var y = 200
            for (var i=0; i<results.length; i++) {
                this.ctx.fillText(results[i].name + ": " + results[i].amount, (this.canvas.width/2) - 100, y);
                y += 50
            }
            this.ctx.font = "40px Arial";
            y += 50
            this.ctx.fillText("Total: " + this.origData.buttons.length, (this.canvas.width/2) - 100, y);
        },
        getCordPlane: function() {
            var yAxis = this.canvas.width / 2
            var xAxis = this.canvas.height / 2
            var mouseX = this.mouseX
            var mouseY = this.mouseY
            if (mouseX > yAxis && mouseY > xAxis) {
                return 1
            } else if (mouseX < yAxis && mouseY > xAxis) {
                return 2
            } else if (mouseX < yAxis && mouseY < xAxis) {
                return 3
            } else if (mouseX > yAxis && mouseY < xAxis) {
                return 4
            } else {
                return 0
            }
        },
        drawSpinner: function() {
            if (! this.spinner) {
                return
            }
            if (! this.spinner.times) {
                this.spinner.times = 0
            }
            this.spinner.times++
            if (this.spinner.times < 50) {
                this.ctx.fillText("Yes", (this.canvas.width/2) - 100, 200);
            }
            var ctx = this.ctx
            var x = this.canvas.width / 2
            var y = this.canvas.height / 2
            ctx.beginPath()
            ctx.arc(x, y, y - 50, 0, Math.PI*2, false)
            ctx.fillStyle = "white";
            ctx.globalAlpha = .75
            ctx.stroke()
            ctx.closePath()
            ctx.fill()
            ctx.globalAlpha = 1
            if (this.spinner.oneTimeAgo != this.getCordPlane() && this.spinner.twoTimesAgo != this.getCordPlane() && this.zxcPressed) {
                this.spinner.twoTimesAgo = this.spinner.oneTimeAgo
                this.spinner.oneTimeAgo = this.getCordPlane()
                this.changeScore(50)
            }
            if (this.getCurrentTime()*1000 > this.spinner.objectParams) {
                delete this.spinner
            }
        },
        getPositionAlongTheLine: function(x1, y1, x2, y2, percentage) {
            //thanks to https://stackoverflow.com/a/57383437/15318223
            return {xx : x1 * (1.0 - percentage) + x2 * percentage, yy : y1 * (1.0 - percentage) + y2 * percentage};
        },
        drawSliders: function() {
            var newSliders = []
            for (var i=0; i<this.sliders.length; i++) {
                if (this.sliders[i].objectParams.curveType == 'L' || this.sliders[i].objectParams.curveType == 'C') {
                    if (! this.sliders[i].startTime) {
                        this.sliders[i].startTime = new Date()
                        this.sliders[i].totalTime = this.sliders[i].objectParams.Length/(this.beatmap.difficulty.SliderMultiplier*100)*this.beatmap.beatLength
                    }
                    var secs = this.sliders[i].totalTime/1000,
                        startx = this.sliders[i].x,
                        starty = this.sliders[i].y,
                        x = this.sliders[i].objectParams.curvePoints[0].x,
                        y = this.sliders[i].objectParams.curvePoints[0].y,
                        startDate = this.sliders[i].startTime,
                        ctx = this.ctx
                    if (new Date() - startDate < secs*1000) {
                        var percentage = ((100/(secs*1000))*(new Date()-startDate))/100
                        var {xx, yy} = this.getPositionAlongTheLine(startx, starty, x, y, percentage)
                        ctx.beginPath()
                        var {x, y} = this.adaptCirclePlacement(xx, yy)
                        ctx.arc(x, y, 40, 0, Math.PI*2, false)
                        ctx.fillStyle = "green"
                        ctx.fill()
                        ctx.closePath()
                        newSliders.push(this.sliders[i])
                    }
                }
            }
            this.sliders = newSliders
        },
        osuPlay: function() {
            if (this.unzipping || (this.videoBack.selected && ! this.videoBack.loaded)) {
                this.ctx.font = "30px Arial";
                this.ctx.fillStyle = "black";
                this.ctx.fillText('Loading...', (this.canvas.width / 2) - 100, 100);
                return
            }
            if (this.videoBack.selected && this.videoBack.loaded) {
                this.drawVideo()
            } else if (this.background.selected && this.background.loaded) {
                this.drawImage()
            }
            this.writeScore()
            this.checkButtons()
            var newButtons = []
            for (var i=0; i<this.beatmap.buttons.length; i++) {
                if (this.getCurrentTime()*1000 > this.beatmap.buttons[i].time-1000 && this.beatmap.buttons[i].objectParams === null) {
                //if (this.getCurrentTime()*1000 > this.beatmap.buttons[i].time-1000 && (this.beatmap.buttons[i].objectParams === null || this.beatmap.buttons[i].type == 1 ||  this.beatmap.buttons[i].type == 2 || this.beatmap.buttons[i].type == 6)) {
                    this.pendingButtons.push(this.beatmap.buttons[i])
                } else if (this.getCurrentTime()*1000 > this.beatmap.buttons[i].time-1000 && (this.beatmap.buttons[i].type == 1 ||  this.beatmap.buttons[i].type == 2 || this.beatmap.buttons[i].type == 6)) {
                    if (this.beatmap.buttons[i].objectParams.curveType == 'L' || this.beatmap.buttons[i].objectParams.curveType == 'C') {
                        if (this.getCurrentTime()*1000 > this.beatmap.buttons[i].time) {
                            this.sliders.push(this.beatmap.buttons[i])
                        } else {
                            newButtons.push(this.beatmap.buttons[i])
                        }
                    } else {
                        this.pendingButtons.push(this.beatmap.buttons[i])
                    }
                } else if (this.getCurrentTime()*1000 > this.beatmap.buttons[i].time && (this.beatmap.buttons[i].type == 3 || this.beatmap.buttons[i].type == 12)) {
                    this.spinner = this.beatmap.buttons[i]
                } else {
                    newButtons.push(this.beatmap.buttons[i])
                }
            }
            this.beatmap.buttons = newButtons
            if (this.beatmap.timingPoints.length > 0 && this.getCurrentTime()*1000 > this.beatmap.timingPoints[0].time-1000) {
                // osu Requires the TimingPoints to be chronological
                var yes = this.beatmap.timingPoints[0]
                if (yes.uninherited) {
                    this.beatmap.beatLength = yes.beatLength
                    this.beatmap.meter = yes.meter
                } else {
                    this.beatmap.meter = null
                }
                this.beatmap.timingPoints = this.beatmap.timingPoints.slice(1)
            }
            this.drawCircles()
            if (this.spinner) {
                this.drawSpinner()
            }
            this.drawSliders()
            
            
            // Developer Stats
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText(this.beatmap.buttons.length, 50, 100);
            
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText(this.currentCircles.length, 50, 150);
            
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText(this.pendingButtons.length, 50, 200);
            
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText(Math.round(this.getCurrentTime()*1000), 50, 250);
            
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText(this.sliders.length, 50, 300);
            
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 20, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("To Home", (this.canvas.width/4 * 3) + 175, 50);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 85, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Restart", (this.canvas.width/4 * 3) + 185, 115);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 150, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            if (this.paused) {
                this.ctx.fillText("Play", (this.canvas.width/4 * 3) + 195, 180);
            } else {
                this.ctx.fillText("Pause", (this.canvas.width/4 * 3) + 195, 180);
            }
        },
        playScreen: function() {
            var left = false, right = false, up = false, down = false
            if (this.rightPressed) {
                right = true
            }
            if (this.downPressed) {
                down = true
            }
            if (this.leftPressed) {
                left = true
            }
            if (this.upPressed) {
                up = true
            }
            if (this.unzipping) {
                this.ctx.font = "30px Arial";
                this.ctx.fillStyle = "black";
                this.ctx.fillText('Loading...', (this.canvas.width / 2) - 100, 100);
                return
            }
            if (this.moveArrowsInter === null) {
                this.moveArrowsInter = setInterval(this.moveArrows.bind(this), 10)
            }
            if (this.background.selected) {
                this.drawImage()
            } else if (this.videoBack.selected && this.videoBack.element.currentTime > 0) {
                this.drawVideo()
            }
            this.writeScore()
            var newKeys = []
            for (var i=0; i<this.data.recording.keys.length; i++) {
                if (this.getCurrentTime() > this.data.recording.keys[i].time - this.delayTime) {
                    this.arrowMoving.push({"direction": this.data.recording.keys[i].key})
                } else {
                    newKeys.push(this.data.recording.keys[i])
                }
            }
            this.data.recording.keys = newKeys
            /*
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText(newKeys.length, 50, 100);
            */
            this.arrow(this.arrowCords.left.x, this.arrowCords.left.y, left) //left
            this.ctx.rotate(90 * Math.PI / 180)
            this.arrow(this.arrowCords.up.x, this.arrowCords.up.y, up) //up
            this.ctx.rotate(90 * Math.PI / 180)
            this.arrow(this.arrowCords.right.x, this.arrowCords.right.y, right) //right
            this.ctx.rotate(90 * Math.PI / 180)
            this.arrow(this.arrowCords.down.x, this.arrowCords.down.y, down) //down
            this.ctx.rotate(90 * Math.PI / 180)
            this.drawMovingArrows()
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 20, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("To Home", (this.canvas.width/4 * 3) + 175, 50);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 85, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Restart", (this.canvas.width/4 * 3) + 185, 115);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 150, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            if (this.paused) {
                this.ctx.fillText("Play", (this.canvas.width/4 * 3) + 195, 180);
            } else {
                this.ctx.fillText("Pause", (this.canvas.width/4 * 3) + 195, 180);
            }
        },
        resultsScreen: function() {
            if (this.background.selected) {
                this.drawImage()
            }
            if (this.moveArrowsInter) {
                clearInterval(this.moveArrowsInter)
                this.moveArrowsInter = null
            }
            this.ctx.beginPath()
            this.ctx.rect(20, 20, 150, 50)
            this.ctx.fillStyle = "black"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Retry", 75, 50);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 20, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("To Home", (this.canvas.width/4 * 3) + 175, 50);
            
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Score: " + Math.round(this.score), 30, 125);
            
            var results = []
            for (var i=0; i<this.stats.length; i++) {
                if (this.stats[i].score == -this.minusScore) {
                    if (! results.missed) {
                        results.missed = 0
                    }
                    results.missed++
                } else {
                    var a = this.getGood(this.stats[i].score)
                    if (! results[a]) {
                        results[a] = 0
                    }
                    results[a]++
                }
            }
            this.ctx.font = "70px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Results", (this.canvas.width/2) - 125, 100);
            
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            var newResults = []
            for (var k in results) {
                newResults.push({"name": k, "amount": results[k]})
            }
            results = newResults
            results.sort(function(a, b) {
                if (a.name == b.name) {
                    return 0
                } else if (a.name == 'Impossibly Good') {
                    return -1
                } else if (b.name == 'Impossibly Good') {
                    return 1
                } else if (a.name == 'Great') {
                    return -1
                } else if (b.name == 'Great') {
                    return 1
                } else if (a.name == 'Good') {
                    return -1
                } else if (b.name == 'Good') {
                    return 1
                } else if (a.name == 'Bad') {
                    return -1
                } else if (b.name == 'Bad') {
                    return 1
                } else if (a.name == 'Terrible') {
                    return -1
                } else if (b.name == 'Terrible') {
                    return 1
                } else if (a.name == 'Missed') {
                    return -1
                } else if (b.name == 'Missed') {
                    return 1
                } else {
                    return 0
                }
            })
            var y = 200
            for (var i=0; i<results.length; i++) {
                this.ctx.fillText(results[i].name + ": " + results[i].amount, (this.canvas.width/2) - 100, y);
                y += 50
            }
            this.ctx.font = "40px Arial";
            y += 50
            this.ctx.fillText("Total: " + this.origData.keys.length, (this.canvas.width/2) - 100, y);
        },
        getGood: function(k) {
            if (k == 'missed') {
                return 'Missed'
            } else if (k < this.addScore && k > this.addScore - 15) {
                return 'Great'
            } else if (k < this.addScore -15 && k > this.addScore - 30) {
                return 'Good'
            } else if (k < this.addScore -30 && k > this.addScore - 45) {
                return 'Bad'
            } else if (k == this.addScore) {
                return 'Impossibly Good'
            } else {
                return 'Terrible'
            }
        },
        uploadBackgroundImage: function() {
            var file = document.createElement('input')
            file.type = 'file'
            file.accept = "image/*"
            file.onchange = function(e) {
                var fileName = e.target.files[0]
                var reader = new FileReader()
                reader.onload = function(e) {
                    var file = e.target.result
                    this.background.selected = true
                    this.background.src = URL.createObjectURL(new Blob([file]))
                    this.background.data = new Uint8Array(file)
                    this.background.element.src = this.background.src
                }.bind(this)
                reader.readAsArrayBuffer(e.target.files[0])
            }.bind(this)
            file.click()
        },
        uploadBackgroundVideo: function() {
            var file = document.createElement('input')
            file.type = 'file'
            file.accept = "video/*"
            file.onchange = function(e) {
                if (! this.fileName) {
                    var fileName = e.target.files[0].name
                    this.fileName = fileName.substr(0, fileName.length - fileName.split('.').pop().length - 1)
                }
                var reader = new FileReader()
                reader.onload = function(e) {
                    var file = e.target.result
                    this.videoBack.selected = true
                    this.videoBack.src = URL.createObjectURL(new Blob([file]))
                    this.videoBack.data = new Uint8Array(file)
                    this.videoBack.element.src = this.videoBack.src
                }.bind(this)
                reader.readAsArrayBuffer(e.target.files[0])
            }.bind(this)
            file.click()
        },
        settings: function() {
            if (this.background.selected) {
                this.drawImage()
            }
            var a = 20
            var b = 50
            if (!this.background.selected) {
                this.ctx.beginPath()
                this.ctx.rect((this.canvas.width/2) - 200, a, 300, 50)
                this.ctx.fillStyle = "green"
                this.ctx.stroke()
                this.ctx.fill()
                this.ctx.font = "20px Arial";
                this.ctx.fillStyle = "white";
                this.ctx.fillText("Upload Background Image", (this.canvas.width/2) - 170, b);
                a += 80
                b += 80
            }
            if (! this.videoBack.selected) {
                this.ctx.beginPath()
                this.ctx.rect((this.canvas.width/2) - 200, a, 300, 50)
                this.ctx.fillStyle = "green"
                this.ctx.stroke()
                this.ctx.fill()
                this.ctx.font = "20px Arial";
                this.ctx.fillStyle = "white";
                this.ctx.fillText("Upload Background Video", (this.canvas.width/2) - 170, b);
                a += 80
                b += 80
            }
            if (! this.audio.selected) {
                this.ctx.beginPath()
                this.ctx.rect((this.canvas.width/2) - 200, a, 300, 50)
                this.ctx.fillStyle = "green"
                this.ctx.stroke()
                this.ctx.fill()
                this.ctx.font = "20px Arial";
                this.ctx.fillStyle = "white";
                this.ctx.fillText("Upload Background Audio", (this.canvas.width/2) - 170, b);
                a += 80
                b += 80
            }
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 20, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Back", (this.canvas.width/4 * 3) + 175, 50);
            
            
        },
        createScreen: function() {
            var left = false, right = false, up = false, down = false
            if (this.rightPressed) {
                right = true
            }
            if (this.downPressed) {
                down = true
            }
            if (this.leftPressed) {
                left = true
            }
            if (this.upPressed) {
                up = true
            }
            if (this.background.selected) {
                this.drawImage()
            } else if (this.videoBack.selected && this.playing) {
                this.drawVideo()
            }
            this.ctx.beginPath()
            this.ctx.rect(20, 20, 150, 50)
            this.ctx.fillStyle = "black"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            if (this.recording) {
                this.ctx.fillText("Stop Recording", 30, 50);
            } else {
                this.ctx.fillText("Record", 50, 50);
            }
            
            this.ctx.beginPath()
            this.ctx.rect(180, 20, 150, 50)
            this.ctx.fillStyle = "yellow"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "green";
            this.ctx.fillText("Save", 220, 50);
            
            this.ctx.beginPath()
            this.ctx.rect(20, 80, 150, 50)
            this.ctx.fillStyle = "yellow"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "green";
            this.ctx.fillText("Reset", 60, 110);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 20, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("To Home", (this.canvas.width/4 * 3) + 175, 50);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 90, 200, 50)
            this.ctx.fillStyle = "purple"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Settings", (this.canvas.width/4 * 3) + 180, 120);
            
            this.arrow(this.arrowCords.left.x, this.arrowCords.left.y, left) //left
            this.ctx.rotate(90 * Math.PI / 180)
            this.arrow(this.arrowCords.up.x, this.arrowCords.up.y, up) //up
            this.ctx.rotate(90 * Math.PI / 180)
            this.arrow(this.arrowCords.right.x, this.arrowCords.right.y, right) //right
            this.ctx.rotate(90 * Math.PI / 180)
            this.arrow(this.arrowCords.down.x, this.arrowCords.down.y, down) //down
            this.ctx.rotate(90 * Math.PI / 180)
            if (this.zipping) {
                this.ctx.font = "30px Arial";
                this.ctx.fillStyle = "black";
                this.ctx.fillText('Processing Files: ' + this.zipStatus + '%', (this.canvas.width/2) - 200, 100);
            }
        },
        chooseAudio: function() {
            var file = document.createElement('input')
            file.type = 'file'
            file.accept = "audio/*"
            file.onchange = function(e) {
                var fileName = e.target.files[0].name
                this.fileName = fileName.substr(0, fileName.length - fileName.split('.').pop().length - 1)
                var reader = new FileReader()
                reader.onload = function(e) {
                    var file = e.target.result
                    this.audio.selected = true
                    this.audio.src = URL.createObjectURL(new Blob([file]))
                    this.audio.data = new Uint8Array(file)
                    this.audio.element.src = this.audio.src
                    this.pause()
                }.bind(this)
                reader.readAsArrayBuffer(e.target.files[0])
                
            }.bind(this)
            file.click()
        },
        record: function() {
            if (!this.audio.selected && !this.videoBack.selected) {
                alert('Please select audio/video in settings tab')
                return
            }
            this.restartAV()
            this.data.recording.keys = []
            this.recording = true
            this.play()
            this.addListener('ended', this.stopRecording.bind(this), false)
            document.addEventListener("keydown", this.recordKey.bind(this), false)
        },
        recordKey: function(e) {
            var time = this.getCurrentTime()
            var key = e.key
            if (e.repeat) {
                return
            }
            if (key == 'ArrowUp') {
                key = 'up'
            } else if (key == 'ArrowDown') {
                key = 'down'
            } else if (key == 'ArrowRight') {
                key = 'right'
            } else if (key == 'ArrowLeft') {
                key = 'left'
            } else {
                return // Do not record other keys
            }
            this.data.recording.keys.push({"key": key, "time": time})
        },
        stopRecording: function() {
            this.recording = false
            this.pause()
            this.audio.element.currentTime = 0
            this.removeListener('ended', this.stopRecording.bind(this), false)
            document.removeEventListener("keydown", this.recordKey.bind(this), false)
        },
        save: async function() {
            if (this.data.recording.keys.length == 0 || (! this.audio.selected && ! this.videoBack.selected)) {
                alert('Nothing to save!')
                return
            }
            this.zip.file('data.json', new Blob([JSON.stringify(this.data.recording)]))
            if (this.videoBack.data) {
                this.zip.file('video', new Blob([this.videoBack.data]))
            }
            if (this.audio.data) {
                this.zip.file('audio', new Blob([this.audio.data]))
            }
            if (this.background.data) {
                this.zip.file('background', new Blob([this.background.data]))
            }
            this.zipping = true
            var blob = await this.zip.generateAsync({type:"blob"}, function updateCallback(metadata) {
                this.zipStatus = metadata.percent.toFixed(2)
                //TODO - Show zipping percent
            }.bind(this))
            var a = document.createElement('a')
            a.href = URL.createObjectURL(blob)
            a.download = this.fileName + '.' + this.extension
            a.click()
            this.zipStatus = null
            this.zipping = false
        },
        renderBall: function() {
            var ctx = this.ctx
            ctx.beginPath()
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2, false)
            ctx.fillStyle = "green"
            ctx.fill()
            ctx.closePath()
        },
        draw: function() {
            this.clear()
            if (this.stage == 'title screen') {
                this.titleScreen()
            } else if (this.stage == 'play screen') {
                this.playScreen()
            } else if (this.stage == 'create screen') {
                this.createScreen()
            } else if (this.stage == 'title2 screen') {
                this.title2Screen()
            } else if (this.stage == 'results screen') {
                this.resultsScreen()
            } else if (this.stage == 'settings') {
                this.settings()
            } else if (this.stage == 'title2 settings') {
                this.title2Settings()
            } else if (this.stage == 'osu play') {
                this.osuPlay()
            } else if (this.stage == 'osu results screen') {
                this.osuResultsScreen()
            } else if (this.stage == 'select osu difficulty') {
                this.osuDifficulty()
            } else {
                this.renderBall()
            }
            this.drawMouse()
            if (window.requestAnimationFrame) {
                requestAnimationFrame(this.draw.bind(this))
            }
        },
        clear: function() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        },
        hidden: function() {
            if (document.visibilityState == 'hidden') {
                this.leftPressed = false
                this.rightPressed = false
                this.downPressed = false
                this.upPressed = false
                if (this.stage == 'play screen') {
                    this.paused = true
                    this.pause()
                }
            }
        },
        up: function(e) {
            var key = e.key
            if (key == 'ArrowUp') {
                this.upPressed = false
            } else if (key == 'ArrowDown') {
                this.downPressed = false
            } else if (key == 'ArrowRight') {
                this.rightPressed = false
            } else if (key == 'ArrowLeft') {
                this.leftPressed = false
            } else if (key == 'z' || key == 'x' || key == 'c') {
                this.zxcPressed = false
            }
        },
        down: function(e) {
            if (this.stage == 'play screen') {
                this.checkArrowDeletion(e)
            }
            var key = e.key
            if (key == 'ArrowUp') {
                this.upPressed = true
            } else if (key == 'ArrowDown') {
                this.downPressed = true
            } else if (key == 'ArrowRight') {
                this.rightPressed = true
            } else if (key == 'ArrowLeft') {
                this.leftPressed = true
            } else if ((key == 'z' || key == 'x' || key == 'c') && ! e.repeat && this.stage == 'osu play') {
                this.screenPress()
            }
            if (key == 'z' || key == 'x' || key == 'c') {
                this.zxcPressed = true
            }
            if (key == 'Enter' && (this.stage == 'play screen' || this.stage == 'osu play')) {
                if (this.paused) {
                    this.paused = false
                    this.play()
                } else {
                    this.paused = true
                    this.pause()
                }
            }
        },
        changeScore: function(w) {
            var a = 0
            this.score = this.score + w
            var v = setInterval(() => {
                if (a == 9) {
                    clearInterval(v)
                }
                a++
                this.dispScore += Math.round(w / 10)
            }, 40)
            //if (q > localStorage.getItem('highScore')) {
            //    localStorage.setItem('highScore', q)
            //}
        },
        writeScore: function() {
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Score: " + Math.round(this.dispScore), 30, 50);
            //this.ctx.fillText("High Score: " + localStorage.getItem('highScore'), 30, 100);
        },
        resizeCanvas: function() {
            this.canvas.width = window.innerWidth
            this.canvas.height = window.innerHeight
        },
        reset: function() {
            this.pause()
            this.rightPressed = false
            this.leftPressed = false
            this.downPressed = false
            this.upPressed = false
            this.zxcPressed = false
            this.paused = false
            this.stats = []
            this.playing = false
            this.arrowMoving = []
            this.stage = 'title screen'
            this.audio = {"src": null, "data": null, "element": document.createElement('audio'), "selected": false, "loaded": false}
            this.background = {"src": null, "data": null, "element": document.createElement('img'), "selected": false, "loaded": false}
            this.videoBack = {"src": null, "data": null, "element": document.createElement('video'), "selected": false, "loaded": false}
            this.recording = false
            this.data = {
                "recording": {
                    "keys": []
                }
            }
            this.fileName = null
            this.origData = null
            this.score = 0
            this.dispScore = 0
            this.zipStatus = null
            this.zipping = false
            this.unzipping = false
            this.moveArrowsInter = null
            this.currentCircles = []
            this.checkButtonsInter = null
            this.pendingButtons = []
            this.beatmap = null
            this.toClick = []
            this.sliders = []
        },
        play: function() {
            this.playing = true
            if (this.audio.selected) {
                this.audio.element.play()
            }
            if (this.videoBack.selected) {
                this.videoBack.element.play()
            }
            if (this.videoBack.selected && this.audio.selected) {
                this.videoBack.element.muted = true
            }
        },
        pause: function() {
            this.playing = false
            if (this.audio.selected) {
                this.audio.element.pause()
            }
            if (this.videoBack.selected) {
                this.videoBack.element.pause()
            }
        },
        getCurrentTime: function() {
            if (this.currentTime) {
                return this.currentTime
            }
            if (this.audio.selected) {
                return this.audio.element.currentTime
            }
            if (this.videoBack.selected) {
                return this.videoBack.element.currentTime
            }
        },
        addListener: function(listener, callback, a) {
            if (this.audio.selected) {
                this.audio.element.addEventListener(listener, callback, a)
            } else if (this.videoBack.selected) {
                this.videoBack.element.addEventListener(listener, callback, a)
            }
        },
        removeListener: function(listener, callback, a) {
            if (this.audio.selected) {
                this.audio.element.removeEventListener(listener, callback, a)
            } else if (this.videoBack.selected) {
                this.videoBack.element.removeEventListener(listener, callback, a)
            }
        },
        restartAV: function() {
            if (this.audio.selected) {
                this.audio.element.currentTime = 0
            }
            if (this.videoBack.selected) {
                this.videoBack.element.currentTime = 0
            }
        },
        drawVideo: function() { // Keep the aspect Ratio
            var videoW = this.videoBack.element.videoWidth
            var videoH = this.videoBack.element.videoHeight
            var x = 0
            var y = 0
            var aspectRatio = videoW / videoH
            if (this.canvas.width > this.canvas.height) {
                while (videoH < this.canvas.height) {
                    videoW = videoW * 1.01
                    videoH = videoH * 1.01
                }
                while (videoH > this.canvas.height) {
                    videoW = videoW / 1.01
                    videoH = videoH / 1.01
                }
            } else {
                while (videoW > this.canvas.width) {
                    videoW = videoW / 1.01
                    videoH = videoH / 1.01
                }
                while (videoW < this.canvas.width) {
                    videoW = videoW * 1.01
                    videoH = videoH * 1.01
                }
            }
            // center the video
            if (this.canvas.width > this.canvas.height) {
                if (this.canvas.width - videoW != 0) {
                    x = (this.canvas.width - videoW) / 2
                }
            } else {
                if (this.canvas.height - videoH != 0) {
                    y = (this.canvas.height - videoH) / 2
                }
            }
            this.ctx.globalAlpha = this.fadeImageVideo
            this.ctx.drawImage(this.videoBack.element, x, y, videoW, videoH);
            this.ctx.globalAlpha = 1
        },
        drawImage: function() { // Keep the aspect Ratio
            var photoW = this.background.element.naturalWidth
            var photoH = this.background.element.naturalHeight
            var x = 0
            var y = 0
            var aspectRatio = photoW / photoH
            if (this.canvas.width > this.canvas.height) {
                while (photoH < this.canvas.height) {
                    photoW = photoW * 1.01
                    photoH = photoH * 1.01
                }
                while (photoH > this.canvas.height) {
                    photoW = photoW / 1.01
                    photoH = photoH / 1.01
                }
            } else {
                while (photoW > this.canvas.width) {
                    photoW = photoW / 1.01
                    photoH = photoH / 1.01
                }
                while (photoW < this.canvas.width) {
                    photoW = photoW * 1.01
                    photoH = photoH * 1.01
                }
            }
            // center the photo
            if (this.canvas.width > this.canvas.height) {
                if (this.canvas.width - photoW != 0) {
                    x = (this.canvas.width - photoW) / 2
                }
            } else {
                if (this.canvas.height - photoH != 0) {
                    y = (this.canvas.height - photoH) / 2
                }
            }
            this.ctx.globalAlpha = this.fadeImageVideo
            this.ctx.drawImage(this.background.element, x, y, photoW, photoH);
            this.ctx.globalAlpha = 1
        }
    }
    new game(document.getElementById("myCanvas"))
</script>

</body>
</html>
