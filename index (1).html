<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Gamedev Canvas Workshop</title>
    <style>
    	* { padding: 0; margin: 0; }
    	canvas { background: #eee; display: block; margin: 0 auto; }
    </style>
</head>
<body>

<canvas id="myCanvas" width="1000" height="600"></canvas>

<script>
    
    window.onerror = function(e) {
        alert(e)
        alert(e.message)
        
    }
    /**
    TODOs
    Support for background colors
    
    */
    
    function game(canvas) {
        this.canvas = canvas
        this.ctx = this.canvas.getContext("2d")
        
        this.resizeCanvas()
        
        this.x = this.canvas.width / 2
        this.y = this.canvas.height / 2
        
        this.rightPressed = false
        this.leftPressed = false
        this.downPressed = false
        this.upPressed = false
        this.paused = false
        
        this.stats = []
        this.minusScore = 150
        this.addScore = 300
        this.playing = false
        
        this.arrowMoving = []
        //this.arrowMoving.push({direction: "left"})
        
        this.arrowCords = {"left": {"x": 500, "y": 325},
                           "up": {"x": 200, "y": -625},
                           "right": {"x": -775, "y": -315},
                           "down": {"x": -455, "y": 640},
                           "travelDistance": 200
                          }
        this.safeZone = 25
        
        
        
        this.stage = 'title screen'
        this.draw()
        
        this.radius = 10
        
        this.audio = {"src": null, "data": null, "element": document.createElement('audio'), "selected": false}
        this.background = {"src": null, "data": null, "element": document.createElement('img'), "selected": false}
        this.videoBack = {"src": null, "data": null, "element": document.createElement('video'), "selected": false}
        this.recording = false
        this.data = {
            "recording": {
                "keys": []
            }
        }
        this.extension = 'fgh' // The extension of the save/load file. Should I have a different name?
        this.fileName = null
        this.origData = null
        
        this.score = 0
        
        this.canvas.addEventListener('click', this.click.bind(this), false)
        document.addEventListener("keydown", this.down.bind(this), false)
        document.addEventListener("keyup", this.up.bind(this), false)
        document.addEventListener("visibilitychange", this.hidden.bind(this), false)
        window.addEventListener('resize', this.resizeCanvas.bind(this), false)
        this.refresh = setInterval(this.draw.bind(this), 10)
        if (typeof JSON.clone != "function") {
            JSON.clone = function(obj) {
                return JSON.parse(JSON.stringify(obj));
            };
        }
        
    }
    game.prototype = {
        isTouching: function(a, b, c, d) {
            var e = window.event;
            var x = e.pageX
            var y = e.pageY
            var cords = [a, b, c, d]
            if (x<cords[2] + cords[0] && x>cords[0] && y>cords[1] && y<cords[3] + cords[1]) {
                return true
            } else {
                return false
            }
        },
        click: function() {
            if (this.stage == 'title screen') {
                if (this.isTouching(20, 20, (this.canvas.width / 2) - 75, this.canvas.height - 50)) {
                    this.stage = 'title2 screen'
                    //this.ask4File()
                } else if (this.isTouching((this.canvas.width / 2) -25, 20, this.canvas.width / 2, this.canvas.height - 50)) {
                    this.stage = 'create screen'
                }
            } else if (this.stage == 'create screen') {
                if (this.isTouching(20, 20, 150, 50)) {
                    if (this.recording) {
                        this.stopRecording()
                    } else {
                        this.record()
                    }
                } else if (this.isTouching(175, 20, 150, 50)) {
                    this.save()
                } else if (this.isTouching((this.canvas.width/4 * 3) + 125, 20, 200, 50)) {
                    this.reset()
                } else if (this.isTouching((this.canvas.width/4 * 3) + 125, 90, 200, 50)) {
                    this.stage = 'settings'
                } else if (this.isTouching(20, 80, 150, 50)) {
                    this.reset()
                    this.stage = 'create screen'
                }
            } else if (this.stage == 'title2 screen') {
                if (this.isTouching((this.canvas.width / 2) - 125, 20, 230, 50)) {
                    this.ask4File()
                } else if (this.isTouching((this.canvas.width/4 * 3) + 125, 20, 200, 50)) {
                    this.reset()
                }
            } else if (this.stage == 'play screen') {
                if (this.isTouching((this.canvas.width/4 * 3) + 125, 20, 200, 50)) {
                    this.reset()
                } else if (this.isTouching((this.canvas.width/4 * 3) + 125, 85, 200, 50)) {
                    this.score = 0
                    this.restartAV()
                    this.pause()
                    this.arrowMoving = []
                    this.stats = []
                    this.data.recording = this.origData
                    setTimeout(() => {
                        this.play()
                    }, 200)
                } else if (this.isTouching((this.canvas.width/4 * 3) + 125, 150, 200, 50)) {
                    if (this.paused) {
                        this.paused = false
                        this.play()
                    } else {
                        this.paused = true
                        this.pause()
                    }
                }
            } else if (this.stage == 'results screen') {
                if (this.isTouching((this.canvas.width/4 * 3) + 125, 20, 200, 50)) {
                    this.reset()
                }
            } else if (this.stage == 'settings') {
                if (this.isTouching((this.canvas.width/4 * 3) + 125, 20, 200, 50)) {
                    this.stage = 'create screen'
                } else if (this.isTouching((this.canvas.width/2) - 200, 20, 300, 50)) {
                    this.uploadBackgroundImage()
                } else if (this.isTouching((this.canvas.width/2) - 200, 100, 300, 50)) {
                    this.uploadBackgroundVideo()
                } else if (this.isTouching((this.canvas.width/2) - 200, 180, 300, 50)) {
                    this.chooseAudio()
                }
            }
        },
        titleScreen: function() {
            this.ctx.beginPath()
            this.ctx.rect(20, 20, (this.canvas.width / 2) - 75, this.canvas.height - 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Play", (this.canvas.width / 2) - 400, (this.canvas.height / 2));
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width / 2) -25, 20, this.canvas.width / 2, this.canvas.height - 50)
            this.ctx.fillStyle = "yellow"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Create", this.canvas.width - 410, (this.canvas.height / 2));
        },
        title2Screen: function() {
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width / 2) - 125, 20, 230, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Click to upload ." + this.extension + " file", (this.canvas.width / 2) - 110, 50);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 20, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("To Home", (this.canvas.width/4 * 3) + 175, 50);
        },
        arrow: function(a, b, filled) {
            var ctx = this.ctx
            ctx.beginPath()
            ctx.moveTo(a, b)
            ctx.lineTo(a-50, b)
            ctx.lineTo(a-50, b+20)
            ctx.lineTo(a-85, b-8)
            ctx.lineTo(a-50, b-35)
            ctx.lineTo(a-50, b-15)
            ctx.lineTo(a, b-15)
            ctx.moveTo(a, b)
            if (filled == 'green') {
                ctx.fillStyle = 'yellow'
            } else if (filled) {
                ctx.fillStyle = "red"
            } else {
                ctx.fillStyle = "black"
            }
            ctx.stroke()
            ctx.fill()
        },
        movingArrows: function() {
            var left = false, right = false, up = false, down = false, remove = false
            if (this.rightPressed) {
                right = true
            }
            if (this.downPressed) {
                down = true
            }
            if (this.leftPressed) {
                left = true
            }
            if (this.upPressed) {
                up = true
            }
            var newArrows = []
            for (var i=0; i<this.arrowMoving.length; i++) {
                var remove = false
                if (this.arrowMoving[i].direction == 'left') {
                    if (! this.arrowMoving[i].x) {
                        this.arrowMoving[i].x = this.arrowCords.left.x - this.arrowCords.travelDistance
                    }
                    this.arrow(this.arrowMoving[i].x, this.arrowCords.left.y, 'green')
                    if (! this.paused) {
                        this.arrowMoving[i].x += 4
                    }
                    if (left && this.arrowCords.left.x-25<this.arrowMoving[i].x && this.arrowMoving[i].x<this.arrowCords.left.x+this.safeZone && ! this.paused) {
                        var remove = true
                        var minusPoints = Math.abs(this.arrowMoving[i].x - this.arrowCords.left.x)
                        this.changeScore(this.addScore - minusPoints)
                        this.stats.push({score: this.addScore - minusPoints})
                    }
                    if (this.arrowMoving[i].x < this.arrowCords.left.x + 50 && !remove) {
                        newArrows.push(this.arrowMoving[i])
                    } else if (this.arrowMoving[i].x > this.arrowCords.left.x + 50) {
                        this.stats.push({score: -this.minusScore})
                        this.changeScore(-this.minusScore)
                    }
                } else if (this.arrowMoving[i].direction == 'up') {
                    if (! this.arrowMoving[i].y) {
                        this.arrowMoving[i].y = this.arrowCords.up.x - this.arrowCords.travelDistance
                    }
                    this.ctx.rotate(90 * Math.PI / 180)
                    this.arrow(this.arrowMoving[i].y, this.arrowCords.up.y, 'green')
                    this.ctx.rotate(-(90 * Math.PI / 180))
                    if (! this.paused) {
                        this.arrowMoving[i].y += 4
                    }
                    if (up && this.arrowCords.up.x-25<this.arrowMoving[i].y && this.arrowMoving[i].y<this.arrowCords.up.x+this.safeZone && ! this.paused) {
                        var remove = true
                        var minusPoints = Math.abs(this.arrowMoving[i].y - this.arrowCords.up.x)
                        this.changeScore(this.addScore - minusPoints)
                        this.stats.push({score: this.addScore - minusPoints})
                    }
                    
                    if (this.arrowMoving[i].y < this.arrowCords.up.x + 50 && !remove) {
                        newArrows.push(this.arrowMoving[i])
                    } else if (this.arrowMoving[i].y > this.arrowCords.up.x + 50) {
                        this.stats.push({score: -this.minusScore})
                        this.changeScore(-this.minusScore)
                    }
                } else if (this.arrowMoving[i].direction == 'right') {
                    if (! this.arrowMoving[i].x) {
                        this.arrowMoving[i].x = this.arrowCords.right.x - this.arrowCords.travelDistance
                    }
                    this.ctx.rotate(180 * Math.PI / 180)
                    this.arrow(this.arrowMoving[i].x, this.arrowCords.right.y, 'green')
                    this.ctx.rotate(-(180 * Math.PI / 180))
                    if (! this.paused) {
                        this.arrowMoving[i].x += 4
                    }
                    if (right && this.arrowCords.right.x-25<this.arrowMoving[i].x && this.arrowMoving[i].x<this.arrowCords.right.x+this.safeZone && ! this.paused) {
                        var remove = true
                        var minusPoints = Math.abs(this.arrowMoving[i].x - this.arrowCords.right.x)
                        this.changeScore(this.addScore - minusPoints)
                        this.stats.push({score: this.addScore - minusPoints})
                    }
                    
                    if (this.arrowMoving[i].x < this.arrowCords.right.x + 50 && !remove) {
                        newArrows.push(this.arrowMoving[i])
                    } else if (this.arrowMoving[i].x > this.arrowCords.right.x + 50) {
                        this.stats.push({score: -this.minusScore})
                        this.changeScore(-this.minusScore)
                    }
                } else if (this.arrowMoving[i].direction == 'down') {
                    if (! this.arrowMoving[i].y) {
                        this.arrowMoving[i].y = this.arrowCords.down.x - this.arrowCords.travelDistance
                    }
                    this.ctx.rotate(90 * 3 * Math.PI / 180)
                    this.arrow(this.arrowMoving[i].y, this.arrowCords.down.y, 'green')
                    this.ctx.rotate(90 * Math.PI / 180)
                    if (! this.paused) {
                        this.arrowMoving[i].y += 4
                    }
                    if (down && this.arrowCords.down.x-25<this.arrowMoving[i].y && this.arrowMoving[i].y<this.arrowCords.down.x+this.safeZone && ! this.paused) {
                        var remove = true
                        var minusPoints = Math.abs(this.arrowMoving[i].y - this.arrowCords.down.x)
                        this.changeScore(this.addScore - minusPoints)
                        this.stats.push({score: this.addScore - minusPoints})
                    }
                    
                    if (this.arrowMoving[i].y < this.arrowCords.down.x + 50 && !remove) {
                        newArrows.push(this.arrowMoving[i])
                    } else if (this.arrowMoving[i].y > this.arrowCords.down.x + 50) {
                        this.stats.push({score: -this.minusScore})
                        this.changeScore(-this.minusScore)
                    }
                }
            }
            this.arrowMoving = newArrows
        },
        ask4File: function() {
            var file = document.createElement('input')
            file.type = 'file'
            file.accept = "." + this.extension
            file.onchange = function(e) {
                this.stage = 'play screen'
                this.paused = false
                var reader = new FileReader()
                reader.onload = function(e) {
                    var data = JSON.parse(e.target.result)
                    this.data.recording = data
                    this.origData = JSON.clone(data)
                    if (data.audioData) {
                        this.audio.data = data.audioData
                        this.audio.src = URL.createObjectURL(new Blob([Uint8Array.from(this.audio.data)]))
                        this.audio.selected = true
                        this.audio.element.src = this.audio.src
                    }
                    if (data.background) {
                        this.background.data = data.background
                        this.background.src = URL.createObjectURL(new Blob([Uint8Array.from(this.background.data)]))
                        this.background.selected = true
                        this.background.element.src = this.background.src
                    }
                    if (data.video) {
                        this.videoBack.data = data.video
                        this.videoBack.src = URL.createObjectURL(new Blob([Uint8Array.from(this.videoBack.data)]))
                        this.videoBack.selected = true
                        this.videoBack.element.src = this.videoBack.src
                    }
                    setTimeout(function() {
                        this.play()
                        this.addListener('ended', function() {this.stage = 'results screen'}.bind(this), false)
                        //this.videoBack.element.currentTime = this.videoBack.element.duration - 5
                    }.bind(this), 100) // Should I add a countdown on the screen?
                }.bind(this)
                reader.readAsText(e.target.files[0])
            }.bind(this)
            file.click()
        },
        playScreen: function() {
            var left = false, right = false, up = false, down = false
            if (this.rightPressed) {
                right = true
            }
            if (this.downPressed) {
                down = true
            }
            if (this.leftPressed) {
                left = true
            }
            if (this.upPressed) {
                up = true
            }
            if (this.background.selected) {
                this.drawImage()
            } else if (this.videoBack.selected && this.videoBack.element.currentTime > 0) {
                this.drawVideo()
            }
            this.writeScore()
            var newKeys = []
            for (var i=0; i<this.data.recording.keys.length; i++) {
                if (this.getCurrentTime() > this.data.recording.keys[i].time - 0.540) {
                    this.arrowMoving.push({"direction": this.data.recording.keys[i].key}) // TODO - Add calibration screen
                } else {
                    newKeys.push(this.data.recording.keys[i])
                }
            }
            this.data.recording.keys = newKeys
            /*
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText(newKeys.length, 50, 100);
            */
            this.arrow(this.arrowCords.left.x, this.arrowCords.left.y, left) //left
            this.ctx.rotate(90 * Math.PI / 180)
            this.arrow(this.arrowCords.up.x, this.arrowCords.up.y, up) //up
            this.ctx.rotate(90 * Math.PI / 180)
            this.arrow(this.arrowCords.right.x, this.arrowCords.right.y, right) //right
            this.ctx.rotate(90 * Math.PI / 180)
            this.arrow(this.arrowCords.down.x, this.arrowCords.down.y, down) //down
            this.ctx.rotate(90 * Math.PI / 180)
            this.movingArrows()
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 20, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("To Home", (this.canvas.width/4 * 3) + 175, 50);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 85, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Restart", (this.canvas.width/4 * 3) + 185, 115);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 150, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            if (this.paused) {
                this.ctx.fillText("Play", (this.canvas.width/4 * 3) + 195, 180);
            } else {
                this.ctx.fillText("Pause", (this.canvas.width/4 * 3) + 195, 180);
            }
        },
        resultsScreen: function() {
            if (this.background.selected) {
                this.drawImage()
            }
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 20, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("To Home", (this.canvas.width/4 * 3) + 175, 50);
            this.writeScore()
            var results = []
            for (var i=0; i<this.stats.length; i++) {
                if (this.stats[i].score == -this.minusScore) {
                    if (! results.missed) {
                        results.missed = 0
                    }
                    results.missed++
                } else {
                    var a = this.getGood(this.stats[i].score)
                    if (! results[a]) {
                        results[a] = 0
                    }
                    results[a]++
                }
            }
            this.ctx.font = "70px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Results", (this.canvas.width/2) - 125, 100);
            
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            var newResults = []
            for (var k in results) {
                newResults.push({"name": k, "amount": results[k]})
            }
            results = newResults
            results.sort(function(a, b) {
                if (a.name == b.name) {
                    return 0
                } else if (a.name == 'Impossibly Good') {
                    return -1
                } else if (b.name == 'Impossibly Good') {
                    return 1
                } else if (a.name == 'Great') {
                    return -1
                } else if (b.name == 'Great') {
                    return 1
                } else if (a.name == 'Good') {
                    return -1
                } else if (b.name == 'Good') {
                    return 1
                } else if (a.name == 'Bad') {
                    return -1
                } else if (b.name == 'Bad') {
                    return 1
                } else if (a.name == 'Terrible') {
                    return -1
                } else if (b.name == 'Terrible') {
                    return 1
                } else if (a.name == 'Missed') {
                    return -1
                } else if (b.name == 'Missed') {
                    return 1
                } else {
                    return 0
                }
            })
            var y = 200
            for (var i=0; i<results.length; i++) {
                this.ctx.fillText(results[i].name + ": " + results[i].amount, (this.canvas.width/2) - 100, y);
                y += 50
            }
            this.ctx.font = "40px Arial";
            y += 50
            this.ctx.fillText("Total: " + this.origData.keys.length, (this.canvas.width/2) - 100, y);
        },
        getGood: function(k) {
            if (k == 'missed') {
                return 'Missed'
            } else if (k < this.addScore && k > this.addScore - 15) {
                return 'Great'
            } else if (k < this.addScore -15 && k > this.addScore - 30) {
                return 'Good'
            } else if (k < this.addScore -30 && k > this.addScore - 45) {
                return 'Bad'
            } else if (k == this.addScore) {
                return 'Impossibly Good'
            } else {
                return 'Terrible'
            }
        },
        uploadBackgroundImage: function() {
            var file = document.createElement('input')
            file.type = 'file'
            file.accept = "image/*"
            file.onchange = function(e) {
                var fileName = e.target.files[0]
                var reader = new FileReader()
                reader.onload = function(e) {
                    var file = e.target.result
                    this.background.selected = true
                    this.background.src = URL.createObjectURL(new Blob([file]))
                    this.background.data = Array.from(new Uint8Array(file))
                    this.background.element.src = this.background.src
                }.bind(this)
                reader.readAsArrayBuffer(e.target.files[0])
            }.bind(this)
            file.click()
        },
        uploadBackgroundVideo: function() {
            var file = document.createElement('input')
            file.type = 'file'
            file.accept = "video/*"
            file.onchange = function(e) {
                if (! this.fileName) {
                    var fileName = e.target.files[0].name
                    this.fileName = fileName.substr(0, fileName.length - fileName.split('.').pop().length - 1)
                }
                var reader = new FileReader()
                reader.onload = function(e) {
                    var file = e.target.result
                    this.videoBack.selected = true
                    this.videoBack.src = URL.createObjectURL(new Blob([file]))
                    this.videoBack.data = Array.from(new Uint8Array(file))
                    this.videoBack.element.src = this.videoBack.src
                }.bind(this)
                reader.readAsArrayBuffer(e.target.files[0])
            }.bind(this)
            file.click()
        },
        settings: function() {
            if (this.background.selected) {
                this.drawImage()
            }
            var a = 20
            var b = 50
            if (!this.background.selected) {
                this.ctx.beginPath()
                this.ctx.rect((this.canvas.width/2) - 200, a, 300, 50)
                this.ctx.fillStyle = "green"
                this.ctx.stroke()
                this.ctx.fill()
                this.ctx.font = "20px Arial";
                this.ctx.fillStyle = "white";
                this.ctx.fillText("Upload Background Image", (this.canvas.width/2) - 170, b);
                a += 80
                b += 80
            }
            if (! this.videoBack.selected) {
                this.ctx.beginPath()
                this.ctx.rect((this.canvas.width/2) - 200, a, 300, 50)
                this.ctx.fillStyle = "green"
                this.ctx.stroke()
                this.ctx.fill()
                this.ctx.font = "20px Arial";
                this.ctx.fillStyle = "white";
                this.ctx.fillText("Upload Background Video", (this.canvas.width/2) - 170, b);
                a += 80
                b += 80
            }
            if (! this.audio.selected) {
                this.ctx.beginPath()
                this.ctx.rect((this.canvas.width/2) - 200, a, 300, 50)
                this.ctx.fillStyle = "green"
                this.ctx.stroke()
                this.ctx.fill()
                this.ctx.font = "20px Arial";
                this.ctx.fillStyle = "white";
                this.ctx.fillText("Upload Background Audio", (this.canvas.width/2) - 170, b);
                a += 80
                b += 80
            }
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 20, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Back", (this.canvas.width/4 * 3) + 175, 50);
            
            
        },
        createScreen: function() {
            var left = false, right = false, up = false, down = false
            if (this.rightPressed) {
                right = true
            }
            if (this.downPressed) {
                down = true
            }
            if (this.leftPressed) {
                left = true
            }
            if (this.upPressed) {
                up = true
            }
            if (this.background.selected) {
                this.drawImage()
            } else if (this.videoBack.selected && this.playing) {
                this.drawVideo()
            }
            this.ctx.beginPath()
            this.ctx.rect(20, 20, 150, 50)
            this.ctx.fillStyle = "black"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            if (this.recording) {
                this.ctx.fillText("Stop Recording", 30, 50);
            } else {
                this.ctx.fillText("Record", 50, 50);
            }
            
            this.ctx.beginPath()
            this.ctx.rect(180, 20, 150, 50)
            this.ctx.fillStyle = "yellow"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "green";
            this.ctx.fillText("Save", 220, 50);
            
            this.ctx.beginPath()
            this.ctx.rect(20, 80, 150, 50)
            this.ctx.fillStyle = "yellow"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "green";
            this.ctx.fillText("Reset", 60, 110);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 20, 200, 50)
            this.ctx.fillStyle = "green"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("To Home", (this.canvas.width/4 * 3) + 175, 50);
            
            this.ctx.beginPath()
            this.ctx.rect((this.canvas.width/4 * 3) + 125, 90, 200, 50)
            this.ctx.fillStyle = "purple"
            this.ctx.stroke()
            this.ctx.fill()
            this.ctx.font = "20px Arial";
            this.ctx.fillStyle = "white";
            this.ctx.fillText("Settings", (this.canvas.width/4 * 3) + 180, 120);
            
            this.arrow(this.arrowCords.left.x, this.arrowCords.left.y, left) //left
            this.ctx.rotate(90 * Math.PI / 180)
            this.arrow(this.arrowCords.up.x, this.arrowCords.up.y, up) //up
            this.ctx.rotate(90 * Math.PI / 180)
            this.arrow(this.arrowCords.right.x, this.arrowCords.right.y, right) //right
            this.ctx.rotate(90 * Math.PI / 180)
            this.arrow(this.arrowCords.down.x, this.arrowCords.down.y, down) //down
            this.ctx.rotate(90 * Math.PI / 180)
        },
        chooseAudio: function() {
            var file = document.createElement('input')
            file.type = 'file'
            file.accept = "audio/*"
            file.onchange = function(e) {
                var fileName = e.target.files[0].name
                this.fileName = fileName.substr(0, fileName.length - fileName.split('.').pop().length - 1)
                var reader = new FileReader()
                reader.onload = function(e) {
                    var file = e.target.result
                    this.audio.selected = true
                    this.audio.src = URL.createObjectURL(new Blob([file]))
                    this.audio.data = Array.from(new Uint8Array(file))
                    this.audio.element.src = this.audio.src
                    this.pause()
                }.bind(this)
                reader.readAsArrayBuffer(e.target.files[0])
                
            }.bind(this)
            file.click()
        },
        record: function() {
            if (!this.audio.selected && !this.videoBack.selected) {
                alert('Please select audio/video in settings tab')
                return
            }
            this.data.recording.keys = []
            this.recording = true
            this.play()
            this.addListener('ended', this.stopRecording.bind(this), false)
            document.addEventListener("keydown", this.recordKey.bind(this), false)
        },
        recordKey: function(e) {
            var time = this.getCurrentTime()
            var key = e.key
            if (key == 'ArrowUp') {
                key = 'up'
            } else if (key == 'ArrowDown') {
                key = 'down'
            } else if (key == 'ArrowRight') {
                key = 'right'
            } else if (key == 'ArrowLeft') {
                key = 'left'
            } else {
                return // Do not record other keys
            }
            this.data.recording.keys.push({"key": key, "time": time})
        },
        stopRecording: function() {
            this.recording = false
            this.pause()
            this.audio.element.currentTime = 0
            this.removeListener('ended', this.stopRecording.bind(this), false)
            document.removeEventListener("keydown", this.recordKey.bind(this), false)
        },
        save: function() {
            if (this.data.recording.keys.length == 0 || (! this.audio.selected && ! this.videoBack.selected)) {
                alert('Nothing to save!')
                return
            }
            var data = this.data.recording
            data.audioData = this.audio.data || undefined
            data.background = this.background.data || undefined
            data.video = this.videoBack.data || undefined
            var data = JSON.stringify(data)
            var a = document.createElement('a')
            a.href = URL.createObjectURL(new Blob([data]))
            a.download = this.fileName + '.' + this.extension
            a.click()
        },
        renderBall: function() {
            var ctx = this.ctx
            ctx.beginPath()
            ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2, false)
            ctx.fillStyle = "green"
            ctx.fill()
            ctx.closePath()
        },
        draw: function() {
            this.clear()
            if (this.stage == 'title screen') {
                this.titleScreen()
            } else if (this.stage == 'play screen') {
                this.playScreen()
            } else if (this.stage == 'create screen') {
                this.createScreen()
            } else if (this.stage == 'title2 screen') {
                this.title2Screen()
            } else if (this.stage == 'results screen') {
                this.resultsScreen()
            } else if (this.stage == 'settings') {
                this.settings()
            } else {
                this.renderBall()
            }
        },
        clear: function() {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        },
        hidden: function() {
            if (document.visibilityState == 'hidden') {
                this.leftPressed = false
                this.rightPressed = false
                this.downPressed = false
                this.upPressed = false
                if (this.stage == 'play screen') {
                    //this.paused = true
                    //this.pause()
                }
            }
        },
        up: function(e) {
            var key = e.key
            if (key == 'ArrowUp') {
                this.upPressed = false
            } else if (key == 'ArrowDown') {
                this.downPressed = false
            } else if (key == 'ArrowRight') {
                this.rightPressed = false
            } else if (key == 'ArrowLeft') {
                this.leftPressed = false
            }
        },
        down: function(e) {
            var key = e.key
            if (key == 'ArrowUp') {
                this.upPressed = true
            } else if (key == 'ArrowDown') {
                this.downPressed = true
            } else if (key == 'ArrowRight') {
                this.rightPressed = true
            } else if (key == 'ArrowLeft') {
                this.leftPressed = true
            }
            if (key == 'Enter' && this.stage == 'play screen') {
                if (this.paused) {
                    this.paused = false
                    this.play()
                } else {
                    this.paused = true
                    this.pause()
                }
            }
        },
        changeScore: function(w) {
            var a = 0
            var q = this.score + w
            var v = setInterval(() => {
                if (a == 9) {
                    clearInterval(v)
                }
                a++
                this.score += Math.round(w / 10)
            }, 40)
            //if (q > localStorage.getItem('highScore')) {
            //    localStorage.setItem('highScore', q)
            //}
        },
        writeScore: function() {
            this.ctx.font = "30px Arial";
            this.ctx.fillStyle = "black";
            this.ctx.fillText("Score: " + this.score, 30, 50);
            //this.ctx.fillText("High Score: " + localStorage.getItem('highScore'), 30, 100);
        },
        resizeCanvas: function() {
            this.canvas.width = window.innerWidth
            this.canvas.height = window.innerHeight
        },
        reset: function() {
            this.x = this.canvas.width / 2
            this.y = this.canvas.height / 2
            this.rightPressed = false
            this.leftPressed = false
            this.downPressed = false
            this.upPressed = false
            this.paused = false
            this.stats = []
            this.minusScore = 150
            this.addScore = 300
            this.playing = false
            this.arrowMoving = []
            this.arrowCords = {"left": {"x": 500, "y": 325},
                               "up": {"x": 200, "y": -625},
                               "right": {"x": -775, "y": -315},
                               "down": {"x": -455, "y": 640},
                               "travelDistance": 200
                              }
            this.safeZone = 25
            this.stage = 'title screen'
            this.draw()
            this.radius = 10
            this.audio = {"src": null, "data": null, "element": document.createElement('audio'), "selected": false}
            this.background = {"src": null, "data": null, "element": document.createElement('img'), "selected": false}
            this.videoBack = {"src": null, "data": null, "element": document.createElement('video'), "selected": false}
            this.recording = false
            this.data = {
                "recording": {
                    "keys": []
                }
            }
            this.extension = 'fgh' // The extension of the save/load file. Should I have a different name?
            this.fileName = null
            this.origData = null
            this.score = 0
        },
        play: function() {
            this.playing = true
            if (this.audio.selected) {
                this.audio.element.play()
            }
            if (this.videoBack.selected) {
                this.videoBack.element.play()
            }
            if (this.videoBack.selected && this.audio.selected) {
                this.videoBack.element.muted = true
            }
        },
        pause: function() {
            this.playing = false
            if (this.audio.selected) {
                this.audio.element.pause()
            }
            if (this.videoBack.selected) {
                this.videoBack.element.pause()
            }
        },
        getCurrentTime: function() {
            if (this.audio.selected) {
                return this.audio.element.currentTime
            }
            if (this.videoBack.selected) {
                return this.videoBack.element.currentTime
            }
        },
        addListener: function(listener, callback, a) {
            if (this.audio.selected) {
                this.audio.element.addEventListener(listener, callback, a)
            } else if (this.videoBack.selected) {
                this.videoBack.element.addEventListener(listener, callback, a)
            }
        },
        removeListener: function(listener, callback, a) {
            if (this.audio.selected) {
                this.audio.element.removeEventListener(listener, callback, a)
            } else if (this.videoBack.selected) {
                this.videoBack.element.removeEventListener(listener, callback, a)
            }
        },
        restartAV: function() {
            if (this.audio.selected) {
                this.audio.element.currentTime = 0
            }
            if (this.videoBack.selected) {
                this.videoBack.element.currentTime = 0
            }
        },
        drawVideo: function() { // Keep the aspect Ratio
            var videoW = this.videoBack.element.videoWidth
            var videoH = this.videoBack.element.videoHeight
            var x = 0
            var y = 0
            var aspectRatio = videoW / videoH
            if (this.canvas.width > this.canvas.height) {
                while (videoH < this.canvas.height) {
                    videoW = videoW * 1.01
                    videoH = videoH * 1.01
                }
                while (videoH > this.canvas.height) {
                    videoW = videoW / 1.01
                    videoH = videoH / 1.01
                }
            } else {
                while (videoW > this.canvas.width) {
                    videoW = videoW / 1.01
                    videoH = videoH / 1.01
                }
                while (videoW < this.canvas.width) {
                    videoW = videoW * 1.01
                    videoH = videoH * 1.01
                }
            }
            // center the video
            if (this.canvas.width > this.canvas.height) {
                if (this.canvas.width - videoW != 0) {
                    x = (this.canvas.width - videoW) / 2
                }
            } else {
                if (this.canvas.height - videoH != 0) {
                    y = (this.canvas.height - videoH) / 2
                }
            }
            this.ctx.drawImage(this.videoBack.element, x, y, videoW, videoH);
        },
        drawImage: function() { // Keep the aspect Ratio
            var photoW = this.background.element.naturalWidth
            var photoH = this.background.element.naturalHeight
            var x = 0
            var y = 0
            var aspectRatio = photoW / photoH
            if (this.canvas.width > this.canvas.height) {
                while (photoH < this.canvas.height) {
                    photoW = photoW * 1.01
                    photoH = photoH * 1.01
                }
                while (photoH > this.canvas.height) {
                    photoW = photoW / 1.01
                    photoH = photoH / 1.01
                }
            } else {
                while (photoW > this.canvas.width) {
                    photoW = photoW / 1.01
                    photoH = photoH / 1.01
                }
                while (photoW < this.canvas.width) {
                    photoW = photoW * 1.01
                    photoH = photoH * 1.01
                }
            }
            // center the photo
            if (this.canvas.width > this.canvas.height) {
                if (this.canvas.width - photoW != 0) {
                    x = (this.canvas.width - photoW) / 2
                }
            } else {
                if (this.canvas.height - photoH != 0) {
                    y = (this.canvas.height - photoH) / 2
                }
            }
            this.ctx.drawImage(this.background.element, x, y, photoW, photoH);
        }
    }
    new game(document.getElementById("myCanvas"))
</script>

</body>
</html>
